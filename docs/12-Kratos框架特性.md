# 12-Kratos æ¡†æ¶ç‰¹æ€§ä¸å¾®æœåŠ¡è¿›é˜¶

> ğŸ’¡ **æ ¸å¿ƒæç¤º**ï¼šKratos ä¸ä»…ä»…æ˜¯ä¸€ä¸ªæ¡†æ¶ï¼Œæ›´æ˜¯ä¸€å¥—å¾®æœåŠ¡è®¾è®¡çš„æ ‡å‡†å®è·µã€‚å®ƒå¼ºè°ƒ **Protobuf First** çš„å¼€å‘æ¨¡å¼ï¼Œå¹¶é€šè¿‡æ¸…æ™°çš„æ¶æ„åˆ†å±‚ï¼ˆTransport/Middlewareï¼‰æ¥è§£è€¦ä¸šåŠ¡ä¸åŸºç¡€è®¾æ–½ã€‚

## 1. Protocol Buffersï¼šå¾®æœåŠ¡çš„â€œæ™®é€šè¯â€

åœ¨ Kratos ä¸­ï¼Œ`.proto` æ–‡ä»¶æ˜¯ç»å¯¹çš„**æ ¸å¿ƒ**ã€‚å®ƒä¸ä»…å®šä¹‰äº†æ•°æ®ç»“æ„ï¼Œè¿˜å®šä¹‰äº†æœåŠ¡æ¥å£ï¼ˆAPIï¼‰ã€‚

### ä¸ºä»€ä¹ˆå®ƒæ˜¯å¿…é¡»çš„ï¼Ÿ

- **å¼ºç±»å‹å¥‘çº¦**ï¼šç›¸æ¯”äº JSON çš„çµæ´»ä½†æ¾æ•£ï¼ŒProtobuf å®šä¹‰äº†ä¸¥æ ¼çš„è¾“å…¥è¾“å‡ºï¼Œé¿å…äº†â€œå­—æ®µæ‹¼å†™é”™è¯¯â€å¯¼è‡´çš„æ‰¯çš®ã€‚
- **è·¨è¯­è¨€æ”¯æŒ**ï¼šåç«¯ç”¨ Goï¼Œå‰ç«¯å¯ä»¥ç”¨ TS ç”Ÿæˆå®¢æˆ·ç«¯ä»£ç ï¼Œç”šè‡³ Python è„šæœ¬ä¹Ÿèƒ½ç›´æ¥è°ƒç”¨ï¼Œå¤§å®¶å…±ç”¨ä¸€ä»½ `.proto` å®šä¹‰ã€‚
- **é«˜æ€§èƒ½**ï¼šäºŒè¿›åˆ¶åºåˆ—åŒ–ï¼Œæ¯” XML/JSON å°ä¸”å¿«ã€‚

### åœ¨ Kratos ä¸­çš„åœ°ä½

Kratos ä¹Ÿæ˜¯ **Protobuf First**ï¼š

1. å…ˆå†™ `.proto` å®šä¹‰ APIã€‚
2. ä½¿ç”¨ `protoc` å·¥å…·ç”Ÿæˆ Go ä»£ç ï¼ˆPayload ç»“æ„ä½“ + gRPC/HTTP æ¥å£å­˜æ ¹ï¼‰ã€‚
3. å¼€å‘è€…åªéœ€è¦å®ç°ç”Ÿæˆçš„ `server` æ¥å£ã€‚

```protobuf
// ä¾‹å­ï¼šå®šä¹‰ä¸€ä¸ªæ‰“æ‹›å‘¼æœåŠ¡
service Greeter {
  // å®šä¹‰ä¸ª APIï¼Œæ—¢èƒ½ç”Ÿæˆ gRPC ä¹Ÿèƒ½é€šè¿‡ google.api.http æ˜ å°„æˆ RESTful æ¥å£
  rpc SayHello (HelloRequest) returns (HelloReply) {
    option (google.api.http) = {
      get: "/helloworld/{name}"
    };
  }
}
```

---

## 2. Kratos æ ¸å¿ƒæœºåˆ¶å¯¼è¯»

Kratos çš„è®¾è®¡éå¸¸æ³¨é‡æ¨¡å—åŒ–ï¼Œå…¶ä¸­ **Transport** å’Œ **Middleware** æ˜¯æœ€ä¸ºç²¾åçš„éƒ¨åˆ†ã€‚

### 2.1 Transport å±‚ (ä¼ è¾“å±‚)

Kratos å°† HTTP å’Œ gRPC ç»Ÿä¸€æŠ½è±¡ä¸º `Transport`ã€‚è¿™æ„å‘³ç€ä½ å¯ä»¥ï¼š

- **ä¸€å¥—ä»£ç ï¼ŒåŒåè®®æ”¯æŒ**ï¼šä½ å†™çš„ä¸šåŠ¡é€»è¾‘ï¼ˆBiz/Serviceï¼‰ä¸éœ€è¦å…³å¿ƒè¯·æ±‚æ˜¯æ¥è‡ªäº HTTP è¿˜æ˜¯ gRPCã€‚å®ƒä»¬åœ¨è¿›å…¥ Service å±‚ä¹‹å‰å·²ç»è¢« Transport å±‚ç»Ÿä¸€é€‚é…äº†ã€‚
- **ä¼˜é›…å¯åŠ¨ä¸åœæ­¢**ï¼šKratos çš„ `App` ç®¡ç†ç€æ‰€æœ‰çš„ Serverï¼ˆHTTP/gRPCï¼‰ï¼Œç»Ÿä¸€å¤„ç†ä¿¡å·é‡ã€ä¼˜é›…å…³é—­ï¼ˆGraceful Shutdownï¼‰ï¼Œä¿è¯è¯·æ±‚ä¸ä¸¢å¤±ã€‚

### 2.2 Middleware (ä¸­é—´ä»¶) æœºåˆ¶

è¿™æ˜¯ Kratos æœ€çµæ´»çš„åœ°æ–¹ã€‚å¦‚æœä½ ç†Ÿæ‚‰ Gin çš„ä¸­é—´ä»¶ï¼ŒKratos çš„ä¹Ÿç±»ä¼¼ï¼Œä½†æ›´å¼ºå¤§ï¼Œå› ä¸ºå®ƒ**åŒæ—¶ä½œç”¨äº HTTP å’Œ gRPC**ã€‚

**Selector è®¾è®¡æ¨¡å¼**ï¼š
ä¸­é—´ä»¶æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªâ€œæ´‹è‘±æ¨¡å‹â€ã€‚è¯·æ±‚è¿›æ¥å…ˆç»è¿‡ Loggingã€Recoveryã€Tracingã€Validate ç­‰ä¸­é—´ä»¶ï¼Œæœ€ååˆ°è¾¾ä½ çš„ Handlerã€‚

```go
// æºç ç®€æï¼šMiddleware æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªå‡½æ•°é—­åŒ…
type Middleware func(Handler) Handler

// åªè¦å®ç°äº†è¿™ä¸ªç­¾åï¼Œå°±èƒ½æ‹¦æˆªè¯·æ±‚
// æ¯”å¦‚æˆ‘ä»¬ä¹‹å‰æƒ³åšçš„â€œAPIè¯·æ±‚è€—æ—¶ç»Ÿè®¡â€ï¼Œå°±å¯ä»¥å†™æˆä¸€ä¸ª Middleware
func ServiceTelemetryMiddleware() middleware.Middleware {
    return func(handler middleware.Handler) middleware.Handler {
        return func(ctx context.Context, req interface{}) (reply interface{}, err error) {
            start := time.Now()
            reply, err = handler(ctx, req) // æ‰§è¡Œä¸‹ä¸€ä¸ªä¸­é—´ä»¶æˆ–ä¸šåŠ¡é€»è¾‘
            duration := time.Since(start)
            // è®°å½•æŒ‡æ ‡...
            return
        }
    }
}
```

**å»ºè®®é˜…è¯»æºç è·¯å¾„**ï¼š

- `transport/http`: çœ‹çœ‹å®ƒæ˜¯å¦‚ä½•é€‚é…æ ‡å‡† `net/http` çš„ã€‚
- `middleware`: çœ‹çœ‹å®˜æ–¹æä¾›çš„ `logging`, `recovery`, `tracing` æ˜¯æ€ä¹ˆå†™çš„ã€‚

---

## 3. æœåŠ¡æ²»ç†å…¥é—¨

éšç€å¾®æœåŠ¡æ•°é‡å¢å¤šï¼ŒæœåŠ¡ä¹‹é—´çš„åä½œï¼ˆæ²»ç†ï¼‰å˜å¾—è‡³å…³é‡è¦ã€‚

### 3.1 æœåŠ¡å‘ç° (Service Discovery)

- **é—®é¢˜**ï¼šå¾®æœåŠ¡ A è¦è°ƒç”¨ å¾®æœåŠ¡ Bã€‚B éƒ¨ç½²äº† 10 ä¸ªå®ä¾‹ï¼ˆIP ä¸åŒï¼‰ï¼ŒA æ€ä¹ˆçŸ¥é“è¿™ 10 ä¸ª IP æ˜¯å¤šå°‘ï¼Ÿå¦‚æœ B çš„æŸä¸ªå®ä¾‹æŒ‚äº†ï¼ŒA æ€ä¹ˆé¿å¼€å®ƒï¼Ÿ
- **è§£å†³**ï¼šå¼•å…¥ä¸€ä¸ªâ€œæ³¨å†Œä¸­å¿ƒâ€ï¼ˆRegistryï¼Œå¦‚ Consul, Etcdï¼‰ã€‚
  - B å¯åŠ¨æ—¶ï¼ŒæŠŠè‡ªå·±çš„ IP æ³¨å†Œåˆ° Registryã€‚
  - A å¯åŠ¨æ—¶ï¼ˆæˆ–è°ƒç”¨æ—¶ï¼‰ï¼Œä» Registry æŸ¥ B çš„ IP åˆ—è¡¨ã€‚
- **Kratos çš„åšæ³•**ï¼šKratos å®šä¹‰äº† `Registry` æ¥å£ã€‚ä½ åªè¦åœ¨é…ç½®é‡Œæ¢ä¸ªæ’ä»¶ï¼Œå°±èƒ½ä» Etcd åˆ‡æ¢åˆ° Consulï¼Œä¸šåŠ¡ä»£ç å®Œå…¨ä¸ç”¨æ”¹ã€‚

### 3.2 ç†”æ–­ä¸é™çº§ (Circuit Breaking & Fallback)

- **é—®é¢˜**ï¼šB æœåŠ¡å› ä¸ºæ•°æ®åº“æ…¢ï¼Œå“åº”å¾ˆæ…¢ã€‚A è°ƒç”¨ B æ—¶ä¸€ç›´åœ¨ç­‰å¾…ï¼Œå¯¼è‡´ A çš„çº¿ç¨‹ä¹Ÿå¡ä½ï¼Œæœ€å A ä¹ŸæŒ‚äº†ï¼ˆé›ªå´©æ•ˆåº”ï¼‰ã€‚
- **è§£å†³ï¼ˆç†”æ–­ï¼‰**ï¼šA å‘ç° B é”™è¯¯ç‡é«˜æˆ–å“åº”æ…¢ï¼Œç›´æ¥â€œè·³é—¸â€ï¼Œä¸å†è°ƒç”¨ Bï¼Œè€Œæ˜¯ç›´æ¥æŠ¥é”™æˆ–è¿”å›é»˜è®¤å€¼ã€‚ç­‰ B å¥½äº†å†æ¢å¤ã€‚
- **è§£å†³ï¼ˆé™çº§ï¼‰**ï¼šB æŒ‚äº†ï¼ŒA è¿”å›ä¸€ä¸ªå…œåº•æ•°æ®ï¼ˆæ¯”å¦‚â€œæš‚æ— æ¨èå†…å®¹â€ï¼‰ï¼Œè€Œä¸æ˜¯ç›´æ¥æŠ¥é”™ crashã€‚

---

## 4. ServiceTelemetry é¡¹ç›®æ¼”è¿›ç»“åˆ

æˆ‘ä»¬ç›®å‰çš„ `ServiceTelemetry` é¡¹ç›®è¿˜æ˜¯å•ä½“ç»“æ„ï¼ˆè™½ç„¶ç›®å½•åˆ†å±‚äº†ï¼‰ï¼Œä¸‹ä¸€æ­¥å‘ Kratos é£æ ¼æ¼”è¿›æ—¶ï¼š

1. **API å®šä¹‰**ï¼šæˆ‘ä»¬ä¼šå¼€å§‹å†™ `.proto` æ–‡ä»¶ï¼Œå®šä¹‰ `Agent` ä¸ŠæŠ¥æ•°æ®çš„æ¥å£ã€‚
2. **æ’ä»¶åŒ–**ï¼šç›®å‰çš„ `internal/probe` å¯ä»¥å°è¯•æ”¹å†™ï¼Œè™½ç„¶å®ƒä¸æ˜¯æ ‡å‡†çš„ HTTP æœåŠ¡ï¼Œä½†æˆ‘ä»¬å¯ä»¥å€Ÿé‰´ Kratos çš„ **Option æ¨¡å¼** æ¥é…ç½®æ¢é’ˆã€‚
3. **ä¸­é—´ä»¶åº”ç”¨**ï¼šé‚£ä¸ª `gin.Handler` é‡Œçš„é€»è¾‘ï¼Œå¯ä»¥æ€è€ƒå³ä¾¿ä¸æ¢æ¡†æ¶ï¼Œèƒ½ä¸èƒ½æŠ½ç¦»æˆç±»ä¼¼ Middleware çš„ç‹¬ç«‹é€»è¾‘å—ï¼Œè€Œä¸æ˜¯å†™æ­»åœ¨ Controller é‡Œã€‚

### æ¨èå­¦ä¹ è·¯å¾„

1. **Protobuf è¯­æ³•**ï¼šå…ˆçœ‹æ‡‚ `message`, `service`, `rpc` å…³é”®å­—ã€‚
2. **Kratos å¿«é€Ÿå¼€å§‹**ï¼šè·‘é€šå®˜æ–¹çš„ `helloworld` demoï¼Œè§‚å¯Ÿç”Ÿæˆçš„ `pb.go` ä»£ç ã€‚
3. **é˜…è¯» Middleware æºç **ï¼šæŒ‘ä¸€ä¸ªç®€å•çš„ï¼ˆå¦‚ `recovery`ï¼‰çœ‹çœ‹å®ƒæ˜¯æ€ä¹ˆ recover panic çš„ã€‚

---

## 5. æ·±å…¥è§£æ Protobuf æ ¸å¿ƒè¯­æ³• (message, service, rpc)

æ—¢ç„¶ä½ å¯¹è¿™ä¸‰ä¸ªå…³é”®å­—æ„Ÿå…´è¶£ï¼Œæˆ‘ä»¬æ¥è¯¦ç»†æ‹†è§£ä¸€ä¸‹ã€‚åœ¨å¾®æœåŠ¡å¼€å‘ä¸­ï¼Œè¿™ä¸‰ä¸ªè¯åˆ†åˆ«å¯¹åº”äº†**æ•°æ®ç»“æ„**ã€**æœåŠ¡å®šä¹‰**å’Œ**æ–¹æ³•å®šä¹‰**ã€‚

### 5.1 `message`ï¼šå®šä¹‰æ•°æ®ç»“æ„

`message` å°±åƒ Go é‡Œçš„ `struct`ã€‚å®ƒå®šä¹‰äº†åœ¨è¿™ä¸ªæœåŠ¡é—´ä¼ è¾“çš„æ•°æ®é•¿ä»€ä¹ˆæ ·ã€‚

```protobuf
// å®šä¹‰ä¸€ä¸ªâ€œç”¨æˆ·â€æ•°æ®ç»“æ„
message User {
  // å­—æ®µæ ¼å¼ï¼šç±»å‹ å­—æ®µå = å”¯ä¸€ç¼–å·;
  
  string name = 1; // å­—ç¬¦ä¸²ç±»å‹
  int32 age = 2;   // æ•´å‹
  bool is_active = 3; // å¸ƒå°”å‹
  
  // ç”šè‡³å¯ä»¥åµŒå¥—
  Address address = 4;
}

message Address {
  string city = 1;
  string street = 2;
}
```

> **ä¸ºä»€ä¹ˆè¦æœ‰å”¯ä¸€ç¼–å· (Tag)ï¼Ÿ**
> Protobuf åºåˆ—åŒ–æˆäºŒè¿›åˆ¶æ—¶ï¼Œä¸å­˜å­—æ®µåï¼ˆå¦‚ "name"ï¼‰ï¼Œåªå­˜è¿™ä¸ªç¼–å·ï¼ˆ1ï¼‰ã€‚
>
> - **ä¼˜ç‚¹**ï¼šæå¤§åœ°å‹ç¼©äº†ä½“ç§¯ã€‚
> - **æ³¨æ„**ï¼šä¸€æ—¦å®šä¹‰å¥½å‘å¸ƒäº†ï¼Œ**åƒä¸‡ä¸è¦ä¿®æ”¹**å·²æœ‰çš„ç¼–å·ï¼ˆæ¯”å¦‚æŠŠ name æ”¹æˆ 2ï¼‰ï¼Œå¦åˆ™æ—§ç‰ˆæœ¬çš„æœåŠ¡å°±è¯»ä¸æ‡‚æ•°æ®äº†ã€‚

### 5.2 `service`ï¼šå®šä¹‰æœåŠ¡æ¥å£

`service` å°±åƒ Go é‡Œçš„ `interface`ã€‚å®ƒå®šä¹‰äº†ä¸€ç»„ç›¸å…³åŠŸèƒ½çš„é›†åˆã€‚åœ¨å¾®æœåŠ¡é‡Œï¼Œé€šå¸¸ä¸€ä¸ªå¾®æœåŠ¡å¯¹åº”ä¸€ä¸ª `service` å®šä¹‰ã€‚

```protobuf
// å®šä¹‰ä¸€ä¸ªâ€œè´¦æˆ·æœåŠ¡â€
service AccountService {
  // é‡Œé¢åŒ…å«å„ç§æ–¹æ³•...
}
```

### 5.3 `rpc`ï¼šå®šä¹‰å…·ä½“æ–¹æ³•

`rpc` (Remote Procedure Call) å°±æ˜¯ `service` é‡Œçš„å…·ä½“å‡½æ•°ã€‚

å®ƒçš„æ ‡å‡†æ ¼å¼éå¸¸å›ºå®šï¼š`rpc æ–¹æ³•å (è¯·æ±‚æ¶ˆæ¯) returns (å“åº”æ¶ˆæ¯);`

```protobuf
service AccountService {
  // 1. æœ€æ™®é€šçš„è°ƒç”¨ï¼šä¸€é—®ä¸€ç­”
  rpc GetUser (GetUserRequest) returns (User);
  
  // 2. åªæœ‰å…¥å‚ï¼Œè¿”å›ä¸ºç©ºï¼ˆç”¨ google.protobuf.Emptyï¼‰
  // rpc DeleteUser (DeleteUserRequest) returns (google.protobuf.Empty);
}

// å¿…é¡»ä¸ºæ¯ä¸ª RPC å®šä¹‰ Request å’Œ Response message
// å“ªæ€•åªæœ‰ä¸€ä¸ªå­—æ®µï¼Œä¹Ÿè¦åŒ…è£…åœ¨ message é‡Œï¼Œè¿™æ˜¯ Protobuf çš„æœ€ä½³å®è·µ
message GetUserRequest {
  string user_id = 1;

  // å³ä½¿è¿™é‡Œç°åœ¨åªæœ‰ä¸€ä¸ªå­—æ®µï¼Œæœªæ¥å¦‚æœé€šè¿‡ ID æŸ¥ä¸åˆ°æƒ³åŠ ä¸ªâ€œæ˜¯å¦å¼ºåˆ¶æŸ¥è¯¢â€ï¼Œç›´æ¥åŠ å­—æ®µå°±è¡Œ
  // è¿™ç§è®¾è®¡ä¿è¯äº†æ¥å£çš„å…¼å®¹æ€§
}
```

### æ€»ç»“å¯¹ç…§è¡¨

| Protobuf å…³é”®å­— | Go è¯­è¨€å¯¹åº”æ¦‚å¿µ | ä½œç”¨ |
| :--- | :--- | :--- |
| `message` | `struct` | å®šä¹‰ä¼ è¾“çš„æ•°æ®åŒ…æ ¼å¼ï¼ˆDTOï¼‰ |
| `service` | `interface` | å®šä¹‰æœåŠ¡çš„æŠ½è±¡æ¥å£ |
| `rpc` | `func` (Function) | å®šä¹‰æ¥å£é‡Œçš„å…·ä½“æ–¹æ³•ç­¾å |

### å®é™…ç”Ÿæˆçš„ Go ä»£ç æ ·å­

Protoc å·¥å…·ä¼šæŠŠä¸Šé¢çš„å®šä¹‰ç¿»è¯‘æˆç±»ä¼¼è¿™æ ·çš„ Go ä»£ç ï¼š

```go
type User struct { // message -> struct
    Name string `protobuf:"bytes,1,opt,name=name" json:"name,omitempty"`
    Age  int32  `protobuf:"varint,2,opt,name=age" json:"age,omitempty"`
    // ...
}

type AccountServiceServer interface { // service -> interface
    GetUser(context.Context, *GetUserRequest) (*User, error) // rpc -> func
}
```

### 5.4 è¿›é˜¶è¯­æ³•ï¼šrepeated, enum, oneof, map

æŒæ¡äº†åŸºç¡€çš„ `message`ã€`service`ã€`rpc` åï¼Œä»¥ä¸‹æ˜¯ä½ ä¼šç»å¸¸ç”¨åˆ°çš„è¿›é˜¶å…³é”®å­—ã€‚

#### `repeated`ï¼šæ•°ç»„/åˆ‡ç‰‡

```protobuf
message User {
  string name = 1;
  repeated string tags = 2;         // å¯¹åº” Go çš„ []string
  repeated Address addresses = 3;   // å¯¹åº” Go çš„ []*Address
}
```

ç”Ÿæˆçš„ Go ä»£ç ï¼š

```go
type User struct {
    Name      string     `json:"name,omitempty"`
    Tags      []string   `json:"tags,omitempty"`       // åˆ‡ç‰‡
    Addresses []*Address `json:"addresses,omitempty"`  // æŒ‡é’ˆåˆ‡ç‰‡
}
```

#### `enum`ï¼šæšä¸¾ç±»å‹

```protobuf
enum UserStatus {
  USER_STATUS_UNSPECIFIED = 0;  // å¿…é¡»æœ‰ 0 å€¼ï¼ˆé»˜è®¤å€¼ï¼‰
  USER_STATUS_ACTIVE = 1;
  USER_STATUS_BANNED = 2;
  USER_STATUS_DELETED = 3;
}

message User {
  string name = 1;
  UserStatus status = 2;  // ä½¿ç”¨æšä¸¾
}
```

ç”Ÿæˆçš„ Go ä»£ç ï¼š

```go
type UserStatus int32

const (
    UserStatus_USER_STATUS_UNSPECIFIED UserStatus = 0
    UserStatus_USER_STATUS_ACTIVE      UserStatus = 1
    UserStatus_USER_STATUS_BANNED      UserStatus = 2
    UserStatus_USER_STATUS_DELETED     UserStatus = 3
)
```

> **å‘½åè§„èŒƒ**ï¼šæšä¸¾å€¼æ¨èåŠ å‰ç¼€ï¼ˆå¦‚ `USER_STATUS_`ï¼‰ï¼Œé¿å…ä¸å…¶ä»–æšä¸¾å†²çªã€‚

#### `oneof`ï¼šäº’æ–¥å­—æ®µï¼ˆåªèƒ½é€‰ä¸€ä¸ªï¼‰

```protobuf
message SearchRequest {
  // æœç´¢æ¡ä»¶ï¼šåªèƒ½æŒ‰ ID æˆ–æŒ‰åå­—æœç´¢ï¼Œä¸èƒ½åŒæ—¶ä¼ 
  oneof search_by {
    string user_id = 1;
    string username = 2;
    string email = 3;
  }
}
```

ç”Ÿæˆçš„ Go ä»£ç ï¼š

```go
type SearchRequest struct {
    // ç”¨æ¥å£å®ç°äº’æ–¥
    SearchBy isSearchRequest_SearchBy  // åªèƒ½æ˜¯ä¸‹é¢ä¸‰ç§ä¹‹ä¸€
}

type SearchRequest_UserId struct { UserId string }
type SearchRequest_Username struct { Username string }
type SearchRequest_Email struct { Email string }
```

ä½¿ç”¨æ—¶éœ€è¦ç±»å‹æ–­è¨€ï¼š

```go
switch v := req.SearchBy.(type) {
case *SearchRequest_UserId:
    // æŒ‰ ID æœç´¢
case *SearchRequest_Username:
    // æŒ‰ç”¨æˆ·åæœç´¢
}
```

#### `map`ï¼šé”®å€¼å¯¹

```protobuf
message User {
  string name = 1;
  map<string, string> metadata = 2;  // å¯¹åº” Go çš„ map[string]string
  map<int32, Address> addresses = 3; // å¯¹åº” Go çš„ map[int32]*Address
}
```

ç”Ÿæˆçš„ Go ä»£ç ï¼š

```go
type User struct {
    Name      string              `json:"name,omitempty"`
    Metadata  map[string]string   `json:"metadata,omitempty"`
    Addresses map[int32]*Address  `json:"addresses,omitempty"`
}
```

> **é™åˆ¶**ï¼šmap çš„ key åªèƒ½æ˜¯æ•´æ•°æˆ–å­—ç¬¦ä¸²ç±»å‹ï¼Œä¸èƒ½æ˜¯æµ®ç‚¹æ•°æˆ– messageã€‚

#### `optional`ï¼ˆProto3 è¯­æ³•ï¼‰

åœ¨ Proto3 ä¸­ï¼Œæ‰€æœ‰å­—æ®µé»˜è®¤éƒ½æ˜¯å¯é€‰çš„ã€‚ä½†å¦‚æœä½ æƒ³**åŒºåˆ†"æ²¡ä¼ "å’Œ"ä¼ äº†é›¶å€¼"**ï¼Œéœ€è¦æ˜¾å¼å£°æ˜ `optional`ï¼š

```protobuf
message UpdateUserRequest {
  string user_id = 1;
  optional string name = 2;       // å¯ä»¥åŒºåˆ† null å’Œç©ºå­—ç¬¦ä¸²
  optional int32 age = 3;         // å¯ä»¥åŒºåˆ† null å’Œ 0
}
```

ç”Ÿæˆçš„ Go ä»£ç ï¼š

```go
type UpdateUserRequest struct {
    UserId string  `json:"user_id,omitempty"`
    Name   *string `json:"name,omitempty"`  // æŒ‡é’ˆï¼nil è¡¨ç¤ºæ²¡ä¼ 
    Age    *int32  `json:"age,omitempty"`   // æŒ‡é’ˆï¼nil è¡¨ç¤ºæ²¡ä¼ 
}
```

### è¿›é˜¶è¯­æ³•å¯¹ç…§è¡¨

| Protobuf | Go ç±»å‹ | ç”¨é€” |
| :--- | :--- | :--- |
| `repeated T` | `[]T` æˆ– `[]*T` | æ•°ç»„/åˆ—è¡¨ |
| `enum` | `int32` + å¸¸é‡ | æœ‰é™çŠ¶æ€é›† |
| `oneof` | æ¥å£ + ç±»å‹æ–­è¨€ | äº’æ–¥å­—æ®µ |
| `map<K, V>` | `map[K]V` | é”®å€¼å¯¹ |
| `optional T` | `*T`ï¼ˆæŒ‡é’ˆï¼‰ | åŒºåˆ†ç©ºå€¼å’Œé›¶å€¼ |

---

## 6. K8s (Kubernetes) åœ¨å…¶ä¸­çš„è§’è‰²

ä½ æåˆ°çš„æ¯”å–» **â€œK8s æ˜¯ Docker çš„ç®¡å®¶â€** éå¸¸ç²¾å‡†ï¼

åœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼ŒKratos å’Œ K8s éƒ½èƒ½å®ç°ç±»ä¼¼çš„åŠŸèƒ½ï¼ˆå¦‚æœåŠ¡å‘ç°ï¼‰ï¼Œä½†å®ƒä»¬å·¥ä½œåœ¨ä¸åŒçš„å±‚é¢ï¼Œ**è·¨è¯­è¨€é€šç”¨æ€§ä¹Ÿä¸åŒ**ã€‚

### 6.1 K8s çš„æ ¸å¿ƒèŒè´£ï¼ˆç®¡å®¶åšäº†ä»€ä¹ˆï¼Ÿï¼‰

å¦‚æœæœ‰ 100 ä¸ªå¾®æœåŠ¡å®ä¾‹ï¼ˆDocker å®¹å™¨ï¼‰ï¼š

- **è°ƒåº¦ (Scheduling)**ï¼šå†³å®šæŠŠå“ªä¸ªå®¹å™¨æ”¾åˆ°å“ªå°æœåŠ¡å™¨ä¸Šè·‘ï¼ˆæ¯”å¦‚è¿™å° CPU é—²ï¼Œå°±æ”¾è¿™ï¼‰ã€‚
- **è‡ªæ„ˆ (Self-healing)**ï¼šå¦‚æœæŸä¸ªå®¹å™¨å´©æºƒäº†ï¼ŒK8s è‡ªåŠ¨é‡å¯å®ƒï¼›å¦‚æœæ•´å°æœåŠ¡å™¨æŒ‚äº†ï¼ŒK8s æŠŠä¸Šé¢çš„å®¹å™¨æŒªåˆ°åˆ«çš„æœºå™¨ã€‚
- **é…ç½®ç®¡ç† (ConfigMap/Secret)**ï¼šæŠŠé…ç½®æ–‡ä»¶æ³¨å…¥åˆ°å®¹å™¨é‡Œã€‚

### 6.2 å…³é”®å†²çªç‚¹ï¼šæœåŠ¡å‘ç° (Service Discovery)

è¿™é‡Œæ˜¯åˆå­¦è€…æœ€å®¹æ˜“æ™•çš„åœ°æ–¹ï¼š**Kratos èƒ½åšæœåŠ¡å‘ç°ï¼ˆç”¨ Consul/Etcdï¼‰ï¼ŒK8s ä¹Ÿèƒ½åšï¼ˆç”¨ DNS/Service IPï¼‰ï¼Œç”¨å“ªä¸ªï¼Ÿ**

| æ–¹æ¡ˆ | Kratos æ–¹å¼ (å®¢æˆ·ç«¯å‘ç°) | K8s æ–¹å¼ (æœåŠ¡ç«¯å‘ç°) |
| :--- | :--- | :--- |
| **åŸç†** | Pod å¯åŠ¨æ—¶è‡ªå·±å» Etcd æ³¨å†Œ IPã€‚å®¢æˆ·ç«¯è°ƒç”¨å‰å…ˆæŸ¥ Etcd æ‹¿åˆ° IP åˆ—è¡¨ï¼Œè‡ªå·±å†³å®šè¿å“ªä¸ªã€‚ | K8s ç»™ä¸€ç»„ Pod åˆ†é…ä¸€ä¸ªè™šæ‹Ÿ IP (ClusterIP)ã€‚å®¢æˆ·ç«¯åªç®¡è°ƒè¿™ä¸ªè™šæ‹Ÿ IPï¼ŒK8s åº•å±‚è´Ÿè´£è½¬å‘ã€‚ |
| **ä¼˜ç‚¹** | **æ›´çµæ´»**ã€‚å®¢æˆ·ç«¯å¯ä»¥åšå¤æ‚çš„è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼ˆæ¯”å¦‚ï¼šP2C ç®—æ³•ï¼Œæˆ–è€…ç°åº¦å‘å¸ƒåªè°ƒ v2 ç‰ˆæœ¬ï¼‰ã€‚ | **è¿™å¯¹åº”ç”¨é€æ˜**ã€‚ä»£ç é‡Œå®Œå…¨ä¸éœ€è¦é›†æˆ Etcd å®¢æˆ·ç«¯ï¼Œä¸ç®¡åç«¯æ€ä¹ˆå˜ï¼Œè°ƒç”¨åœ°å€ä¸å˜ã€‚ |
| **ç¼ºç‚¹** | ä»£ç è¦é›†æˆæ³¨å†Œä¸­å¿ƒ SDKï¼Œä¾èµ–å¤–éƒ¨ç»„ä»¶ (Etcd)ã€‚ | è´Ÿè½½å‡è¡¡ç­–ç•¥æ¯”è¾ƒæ­»æ¿ï¼ˆé€šå¸¸æ˜¯è½®è¯¢ï¼‰ï¼Œéš¾ä»¥åšç²¾ç»†åŒ–æ§åˆ¶ã€‚ |
| **è·¨è¯­è¨€** | âš ï¸ **Go ç”Ÿæ€ä¸“å±**ã€‚å¦‚æœæœ‰ Python/Java æœåŠ¡ï¼Œå®ƒä»¬ä¹Ÿè¦å„è‡ªé›†æˆ Etcd SDKï¼Œå¢åŠ å¤æ‚åº¦ã€‚ | âœ… **è¯­è¨€æ— å…³**ã€‚ä»»ä½•è¯­è¨€å†™çš„æœåŠ¡ï¼Œåªè¦éƒ¨ç½²åœ¨ K8s é‡Œï¼Œéƒ½èƒ½ç”¨ DNS äº’è°ƒã€‚ |

### 6.3 æœ€ä½³å®è·µå»ºè®®

å¯¹äº **Go + Kratos** å¾®æœåŠ¡ï¼Œé€šå¸¸æœ‰ä¸¤ç§æµæ´¾ï¼š

1. **çº¯ K8s æ¨¡å¼ï¼ˆé€‚åˆåˆæœŸï¼‰**ï¼š
    - ä¸ç”¨ Etcdï¼Œä¸ç”¨ Consulã€‚
    - ç›´æ¥ç”¨ K8s çš„ Service åŸŸåè°ƒç”¨ï¼ˆå¦‚ `http://account-service:8000`ï¼‰ã€‚
    - ç®€å•ï¼Œè¿ç»´æˆæœ¬ä½ã€‚

2. **Kratos + K8s æ··åˆæ¨¡å¼ï¼ˆé€‚åˆå¤§å‚/é«˜æ€§èƒ½ï¼‰**ï¼š
    - K8s è´Ÿè´£éƒ¨ç½²å’Œä¿æ´»ï¼ˆç®¡å®¶èŒè´£ï¼‰ã€‚
    - Kratos è´Ÿè´£æœåŠ¡å‘ç°ï¼ˆç»•è¿‡ K8s çš„ Service IPï¼Œç›´æ¥ç‚¹å¯¹ç‚¹è¿ Pod IPï¼‰ã€‚
    - **ä¸ºä»€ä¹ˆï¼Ÿ** å› ä¸º K8s çš„è½¬å‘æœ‰ä¸€ç‚¹ç‚¹æ€§èƒ½æŸè€—ï¼Œä¸”ä¸å¦‚å®¢æˆ·ç«¯ç›´è¿çµæ´»ã€‚

> **ç»“è®º**ï¼šæ—¢ç„¶æˆ‘ä»¬åˆšå¼€å§‹å­¦ï¼Œä½ å¯ä»¥å…ˆæŠŠ K8s å½“ä½œçº¯ç²¹çš„**éƒ¨ç½²è¿ç»´å¹³å°**ï¼ˆç®¡å®¶ï¼‰ï¼Œè´Ÿè´£æŠŠä½ çš„ Go ç¨‹åºè·‘èµ·æ¥ã€åˆ«æŒ‚æ‰ã€‚æœåŠ¡å†…éƒ¨çš„é€»è¾‘ï¼ˆå¦‚ API å®šä¹‰ã€æ•°æ®éªŒè¯ï¼‰äº¤ç»™ Kratosã€‚

---

## 7. å¾®æœåŠ¡ä¸­çš„è·¯ç”±å±‚æ¶æ„

åœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼Œ"è·¯ç”±"ä¸ä»…ä»…æ˜¯ URL åŒ¹é…ï¼Œè€Œæ˜¯æ¶‰åŠ**å¤šå±‚çš„è¯·æ±‚åˆ†å‘**ã€‚

### 7.1 ä¸‰å±‚è·¯ç”±ç»“æ„

```
                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                     â”‚                   å¤–éƒ¨è¯·æ±‚ (å®¢æˆ·ç«¯/æµè§ˆå™¨)                  â”‚
                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1ï¸âƒ£ API ç½‘å…³ (å¤–éƒ¨è·¯ç”±å±‚)                                                                       â”‚
â”‚    - Nginx / Kong / Traefik / K8s Ingress                                                 â”‚
â”‚    - èŒè´£ï¼šSSL å¸è½½ã€é™æµã€è®¤è¯ã€æŒ‰è·¯å¾„åˆ†å‘åˆ°ä¸åŒå¾®æœåŠ¡                                               â”‚
â”‚    - ä¾‹å­ï¼š/user/* â†’ user-service, /order/* â†’ order-service                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2ï¸âƒ£ å¾®æœåŠ¡å†…éƒ¨è·¯ç”±å±‚ (Kratos Transport/HTTP Server)                                             â”‚
â”‚    - æ¯ä¸ªå¾®æœåŠ¡å†…éƒ¨çš„ HTTP/gRPC Server                                                          â”‚
â”‚    - èŒè´£ï¼šæ¥æ”¶è¯·æ±‚ï¼Œåˆ†å‘åˆ°å…·ä½“çš„ Handler/Service æ–¹æ³•                                             â”‚
â”‚    - Kratosï¼šç”± .proto æ–‡ä»¶è‡ªåŠ¨ç”Ÿæˆï¼Œå¼€å‘è€…ä¸éœ€è¦æ‰‹å†™è·¯ç”±                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3ï¸âƒ£ ä¸šåŠ¡é€»è¾‘å±‚ (Biz/Service)                                                                   â”‚
â”‚    - å®é™…å¤„ç†ä¸šåŠ¡é€»è¾‘çš„åœ°æ–¹                                                                       â”‚
â”‚    - ä¸è·¯ç”±è§£è€¦ï¼Œåªå…³å¿ƒè¾“å…¥è¾“å‡º                                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.2 Kratos çš„"æ— è·¯ç”±"è®¾è®¡

åœ¨ Kratos æ¡†æ¶é‡Œï¼Œä½ å‡ ä¹**ä¸éœ€è¦æ‰‹å†™è·¯ç”±**ã€‚è·¯ç”±æ˜¯é€šè¿‡ `.proto` æ–‡ä»¶**ç”Ÿæˆ**çš„ã€‚

```protobuf
// api/user/v1/user.proto
service UserService {
  // è¿™é‡Œçš„ option å°±æ˜¯è·¯ç”±å®šä¹‰ï¼
  rpc GetUser (GetUserRequest) returns (User) {
    option (google.api.http) = {
      get: "/api/v1/user/{id}"   // å¯¹åº” GET /api/v1/user/123
    };
  }

  rpc CreateUser (CreateUserRequest) returns (User) {
    option (google.api.http) = {
      post: "/api/v1/user"
      body: "*"
    };
  }
}
```

æ‰§è¡Œ `kratos proto client` åï¼Œä¼šè‡ªåŠ¨ç”Ÿæˆ HTTP è·¯ç”±ä»£ç ï¼Œä½ **åªéœ€è¦å®ç°ä¸šåŠ¡é€»è¾‘**ï¼š

```go
// internal/service/user.go
func (s *UserService) GetUser(ctx context.Context, req *v1.GetUserRequest) (*v1.User, error) {
    // ç›´æ¥å†™ä¸šåŠ¡é€»è¾‘ï¼Œä¸ç”¨ç®¡è·¯ç”±
    user, err := s.uc.GetUser(ctx, req.Id)
    return user, err
}
```

### 7.3 å¯¹æ¯”ä¼ ç»Ÿ Gin è·¯ç”±

| ç‰¹ç‚¹ | ä¼ ç»Ÿ Gin è·¯ç”± | Kratos é£æ ¼ |
|------|--------------|-------------|
| **å®šä¹‰æ–¹å¼** | æ‰‹å†™ `r.GET("/user/:id", handler)` | åœ¨ `.proto` é‡Œç”¨ `option (google.api.http)` |
| **åè®®æ”¯æŒ** | ä»… HTTP | HTTP + gRPC è‡ªåŠ¨åŒåè®® |
| **ç»´æŠ¤æˆæœ¬** | è·¯ç”±åˆ†æ•£åœ¨ä»£ç å„å¤„ | é›†ä¸­åœ¨ `.proto` æ–‡ä»¶ |
| **ç±»å‹å®‰å…¨** | æ‰‹åŠ¨è§£æå‚æ•° | è‡ªåŠ¨ç”Ÿæˆå¼ºç±»å‹ Request/Response |

> **æ€»ç»“**ï¼šåœ¨ Kratos å¾®æœåŠ¡é‡Œï¼Œ"è·¯ç”±"è¿™ä¸ªæ¦‚å¿µè¢«å¼±åŒ–äº†ã€‚ä½ å®šä¹‰çš„æ˜¯**API å¥‘çº¦ï¼ˆ.protoï¼‰**ï¼Œè€Œä¸æ˜¯è·¯ç”±è§„åˆ™ã€‚è·¯ç”±åªæ˜¯å¥‘çº¦çš„å‰¯äº§å“ã€‚
