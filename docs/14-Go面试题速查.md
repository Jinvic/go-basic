# 14-Go é¢è¯•é¢˜é€ŸæŸ¥

> ğŸ’¡ **ä½¿ç”¨æŒ‡å—**ï¼šè¿™ä»½æ–‡æ¡£æ”¶å½•äº† Go é«˜é¢‘é¢è¯•é¢˜ï¼Œæ¯é¢˜é™„å¸¦ç®€ç­”ç‰ˆå’Œè¯¦è§£ç‰ˆï¼Œæ–¹ä¾¿å¿«é€Ÿå¤ä¹ ã€‚

---

## 1. ä¸ºä»€ä¹ˆé€‰æ‹© Goï¼Ÿç›¸æ¯” Java æœ‰å“ªäº›ä¼˜åŠ¿ï¼Ÿ

| ç»´åº¦ | Go | Java |
|------|-----|------|
| **å¹¶å‘æ¨¡å‹** | Goroutineï¼ˆ2KB èµ·æ­¥ï¼Œç™¾ä¸‡çº§è½»æ¾ï¼‰ | Threadï¼ˆ1MB èµ·æ­¥ï¼Œä¸‡çº§å°±åƒåŠ›ï¼‰ |
| **å†…å­˜å ç”¨** | ä½ï¼Œé™æ€ç¼–è¯‘æ—  VM | é«˜ï¼ŒJVM åƒå†…å­˜ |
| **å¯åŠ¨é€Ÿåº¦** | æ¯«ç§’çº§ | ç§’çº§ï¼ˆJVM é¢„çƒ­ï¼‰ |
| **éƒ¨ç½²** | å•äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œæ— ä¾èµ– | éœ€è¦ JRE/JDK |
| **è¯­æ³•** | æç®€ï¼ˆ25 ä¸ªå…³é”®å­—ï¼‰ | å¤æ‚ï¼ˆæ³›å‹ã€æ³¨è§£ã€åå°„...ï¼‰ |
| **é€‚ç”¨åœºæ™¯** | äº‘åŸç”Ÿã€å¾®æœåŠ¡ã€CLI å·¥å…· | ä¼ä¸šçº§ã€å¤§å‹å•ä½“ã€å¤æ‚ä¸šåŠ¡ |

**é¢è¯•ç®€ç­”**ï¼š
> "Go çš„åç¨‹æ›´è½»é‡ï¼ˆ2KB vs 1MBï¼‰ã€ç¼–è¯‘å¿«ã€éƒ¨ç½²ç®€å•ï¼ˆå•äºŒè¿›åˆ¶ï¼‰ã€å¤©ç„¶é€‚åˆäº‘åŸç”Ÿå’Œå¾®æœåŠ¡åœºæ™¯ã€‚Java åœ¨å¤æ‚ä¸šåŠ¡é€»è¾‘å’Œç”Ÿæ€æˆç†Ÿåº¦ä¸Šæ›´æœ‰ä¼˜åŠ¿ã€‚"

---

## 2. Goroutine è¿‡å¤šçš„é—®é¢˜ & å†…å­˜æ³„æ¼åœºæ™¯

### Goroutine è¿‡å¤šçš„é—®é¢˜

```
1. å†…å­˜æš´æ¶¨ï¼šæ¯ä¸ª Goroutine è‡³å°‘ 2KB æ ˆï¼Œ100ä¸‡ä¸ª = 2GB
2. è°ƒåº¦å¼€é”€ï¼šé¢‘ç¹åˆ‡æ¢æ¶ˆè€— CPU
3. èµ„æºè€—å°½ï¼šå¦‚æœéƒ½åœ¨åš I/Oï¼Œå¯èƒ½è€—å°½æ–‡ä»¶æè¿°ç¬¦
```

> **ä»€ä¹ˆæ˜¯æ–‡ä»¶æè¿°ç¬¦ (File Descriptor)ï¼Ÿ**
> æ“ä½œç³»ç»Ÿç”¨æ¥è¿½è¸ª"æ‰“å¼€çš„èµ„æº"çš„ç¼–å·ã€‚æ¯æ¬¡æ‰“å¼€æ–‡ä»¶ã€å»ºç«‹ç½‘ç»œè¿æ¥ï¼Œç³»ç»Ÿéƒ½ä¼šåˆ†é…ä¸€ä¸ªå°æ•´æ•°ï¼ˆFDï¼‰ã€‚
>
> - é»˜è®¤é™åˆ¶ï¼šLinux æ¯è¿›ç¨‹ 1024 ä¸ª
> - è€—å°½åæœï¼š`too many open files` é”™è¯¯
> - é¢„é˜²æ–¹æ³•ï¼šåŠæ—¶ `Close()`ã€è°ƒå¤§ `ulimit -n`

### å¸¸è§å†…å­˜æ³„æ¼åœºæ™¯

```go
// 1ï¸âƒ£ Goroutine æ³„æ¼ï¼ˆæœ€å¸¸è§ï¼ï¼‰
func leak() {
    ch := make(chan int)
    go func() {
        val := <-ch  // æ°¸è¿œé˜»å¡ï¼Œæ²¡äººå¾€ ch å‘æ•°æ®
        fmt.Println(val)
    }()
    // å‡½æ•°è¿”å›ï¼Œä½† goroutine æ°¸è¿œåœ¨ç­‰
}

// 2ï¸âƒ£ å¿˜è®°å…³é—­èµ„æº
resp, _ := http.Get(url)
// å¿˜è®° resp.Body.Close()

// 3ï¸âƒ£ time.Ticker å¿˜è®° Stop
ticker := time.NewTicker(time.Second)
// å¿˜è®° ticker.Stop()
// ğŸ’¡ time.Ticker æ˜¯å‘¨æœŸå®šæ—¶å™¨ï¼Œæ¯éš”å›ºå®šæ—¶é—´å¾€ ticker.C å‘ä¸€ä¸ªå€¼
//    ç”¨å®Œä¸ Stopï¼Œå®ƒä¼šä¸€ç›´åœ¨åå°è·‘ï¼Œé€ æˆ Goroutine æ³„æ¼

// 4ï¸âƒ£ åˆ‡ç‰‡åº•å±‚æ•°ç»„æœªé‡Šæ”¾
data := make([]byte, 1<<20)  // 1MB
small := data[:10]           // small ä»å¼•ç”¨æ•´ä¸ª 1MB

// 5ï¸âƒ£ map åªå¢ä¸åˆ 
cache := make(map[string]interface{})
// ä¸æ–­ Addï¼Œä»ä¸ Deleteï¼Œå³ä½¿å€¼ä¸º nil ä¹Ÿå å†…å­˜
```

**é¢è¯•ç®€ç­”**ï¼š
> "Goroutine è¿‡å¤šä¼šå¯¼è‡´å†…å­˜æš´æ¶¨å’Œè°ƒåº¦å¼€é”€ã€‚å¸¸è§æ³„æ¼åœºæ™¯åŒ…æ‹¬ï¼šGoroutine é˜»å¡åœ¨ channel ä¸Šæ— æ³•é€€å‡ºã€å¿˜è®°å…³é—­ HTTP Bodyã€time.Ticker å¿˜è®° Stopã€åˆ‡ç‰‡å¼•ç”¨å¤§æ•°ç»„ã€‚"

---

## 3. GMP è°ƒåº¦æ¨¡å‹

### ä¸‰ä¸ªæ ¸å¿ƒç»„ä»¶

```
G = Goroutineï¼ˆåç¨‹ï¼Œç”¨æˆ·æ€è½»é‡çº¿ç¨‹ï¼‰
M = Machineï¼ˆOS çº¿ç¨‹ï¼ŒçœŸæ­£æ‰§è¡Œä»£ç ï¼‰
P = Processorï¼ˆé€»è¾‘å¤„ç†å™¨ï¼ŒæŒæœ‰æœ¬åœ°è¿è¡Œé˜Ÿåˆ—ï¼Œé»˜è®¤ = GOMAXPROCS = CPU æ ¸å¿ƒæ•°ï¼‰
```

### æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å…¨å±€é˜Ÿåˆ— (Global Queue)ï¼šå­˜æ”¾ç­‰å¾…è¿è¡Œçš„ G          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“ å¶å°”è·å–ï¼ˆæ¯ 61 æ¬¡è°ƒåº¦æ£€æŸ¥ä¸€æ¬¡ï¼‰
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   P1    â”‚     â”‚   P2    â”‚     â”‚   P3    â”‚  â† é€»è¾‘å¤„ç†å™¨
â”‚ æœ¬åœ°é˜Ÿåˆ— â”‚     â”‚ æœ¬åœ°é˜Ÿåˆ— â”‚     â”‚ æœ¬åœ°é˜Ÿåˆ— â”‚  â† æ— é”è®¿é—®ï¼
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚               â”‚               â”‚
     â†“               â†“               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   M1   â”‚     â”‚   M2   â”‚     â”‚   M3   â”‚  â† OS çº¿ç¨‹
â”‚ æ‰§è¡Œ G  â”‚     â”‚ æ‰§è¡Œ G  â”‚     â”‚ æ‰§è¡Œ G  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒä¼˜åŒ–è®¾è®¡

| è®¾è®¡ | ä½œç”¨ |
|------|------|
| **P çš„æœ¬åœ°é˜Ÿåˆ—** | æ— é”è®¿é—®ï¼Œå‡å°‘å…¨å±€ç«äº‰ |
| **Work Stealing** | P ç©ºé—²æ—¶å·å…¶ä»– P çš„ä»»åŠ¡ï¼Œè´Ÿè½½å‡è¡¡ |
| **Hand Off** | M é˜»å¡æ—¶ï¼ŒP äº¤ç»™å…¶ä»– M ç»§ç»­å·¥ä½œ |
| **M:N è°ƒåº¦** | å°‘é‡ OS çº¿ç¨‹æ‰¿è½½å¤§é‡ Goroutine |
| **æŠ¢å å¼è°ƒåº¦** | æ¯ 10ms æ£€æŸ¥ï¼Œé˜²æ­¢ G é•¿æ—¶é—´éœ¸å  |

**é¢è¯•ç®€ç­”**ï¼š
> "GMP æ˜¯ Go çš„è°ƒåº¦æ¨¡å‹ã€‚G æ˜¯åç¨‹ï¼ŒM æ˜¯ OS çº¿ç¨‹ï¼ŒP æ˜¯é€»è¾‘å¤„ç†å™¨ã€‚P æŒæœ‰æœ¬åœ°é˜Ÿåˆ—å®ç°æ— é”è°ƒåº¦ï¼Œç©ºé—²æ—¶é€šè¿‡ Work Stealing å·å…¶ä»– P çš„ä»»åŠ¡ã€‚M é˜»å¡æ—¶ä¼š Hand Offï¼ŒæŠŠ P äº¤ç»™å…¶ä»– Mï¼Œä¿è¯ P ä¸Šçš„ G ä¸è¢«é¥¿æ­»ã€‚"

---

## 4. Work-Stealing æœºåˆ¶

### æµç¨‹æ¦‚è§ˆ

```
åˆå§‹çŠ¶æ€:
P1 é˜Ÿåˆ—: [G1, G2, G3, G4]   â† å¾ˆå¿™
P2 é˜Ÿåˆ—: []                  â† ç©ºé—²

Work Stealing è§¦å‘:
1. P2 å‘ç°è‡ªå·±æ²¡æ´»å¹²
2. éšæœºé€‰ä¸€ä¸ª Pï¼ˆæ¯”å¦‚ P1ï¼‰
3. ä» P1 é˜Ÿåˆ—å°¾éƒ¨å·ä¸€åŠ â†’ [G3, G4]

ç»“æœ:
P1 é˜Ÿåˆ—: [G1, G2]
P2 é˜Ÿåˆ—: [G3, G4]  â† è´Ÿè½½å‡è¡¡äº†ï¼
```

### åº•å±‚å®ç°åŸç†

#### 1. æ•°æ®ç»“æ„ï¼šæœ¬åœ°é˜Ÿåˆ—æ˜¯ç¯å½¢æ•°ç»„

```go
// runtime/runtime2.go
type p struct {
    runqhead uint32        // å¤´æŒ‡é’ˆï¼ˆæœ¬åœ° P ä»è¿™å–ï¼‰
    runqtail uint32        // å°¾æŒ‡é’ˆï¼ˆæ–° G æ”¾è¿™ï¼‰
    runq     [256]guintptr // ç¯å½¢æ•°ç»„ï¼Œå›ºå®š 256 ä¸ªæ§½ä½
}
```

#### 2. å·å–æ—¶çš„åŸå­æ“ä½œï¼ˆç®€åŒ–ç‰ˆï¼‰

```go
// ç®€åŒ–ç‰ˆ runtime/proc.go çš„ runqsteal å‡½æ•°
func runqsteal(p, p2 *p) *g {
    // 1. åŸå­è¯»å–ç›®æ ‡ P çš„ head å’Œ tail
    h := atomic.LoadAcq(&p2.runqhead)
    t := atomic.LoadAcq(&p2.runqtail)
    
    // 2. è®¡ç®—è¦å·çš„æ•°é‡ï¼ˆä¸€åŠï¼‰
    n := t - h
    n = n - n/2
    
    // 3. ä» tail ç«¯æ‰¹é‡æ‹·è´åˆ°è‡ªå·±çš„é˜Ÿåˆ—
    for i := uint32(0); i < n; i++ {
        g := p2.runq[(h+i) % 256]
        p.runq[(p.runqtail+i) % 256] = g
    }
    
    // 4. CAS æ›´æ–°ç›®æ ‡ P çš„ headï¼ˆå…³é”®ï¼æ— é”å¹¶å‘å®‰å…¨ï¼‰
    if !atomic.CasRel(&p2.runqhead, h, h+n) {
        return nil  // åˆ«äººå…ˆå·äº†ï¼Œé‡è¯•
    }
    
    return firstStolenG
}
```

### æ ¸å¿ƒè®¾è®¡åŸç†

| è®¾è®¡ | åŸç† | å¥½å¤„ |
|------|------|------|
| **ç¯å½¢æ•°ç»„** | å›ºå®š 256 æ§½ä½ | é¿å…åŠ¨æ€åˆ†é…ï¼Œå†…å­˜å±€éƒ¨æ€§å¥½ |
| **å¤´å°¾åˆ†ç¦»** | æœ¬åœ°ä»å¤´å–ï¼Œåˆ«äººä»å°¾å· | å‡å°‘å¹¶å‘å†²çª |
| **CAS åŸå­æ“ä½œ** | å·å–æ—¶ç”¨ CAS æ›´æ–° head | æ— é”å¹¶å‘å®‰å…¨ |
| **å·ä¸€åŠ** | æ‰¹é‡å·å– | å‡å°‘å·å–æ¬¡æ•°ï¼Œå‡è¡¡è´Ÿè½½ |
| **éšæœºé€‰æ‹©** | éšæœºé€‰ç›®æ ‡ P | é¿å…å¤šä¸ª P åŒæ—¶å·åŒä¸€ä¸ª |

### å¹¶å‘å†²çªå¦‚ä½•è§£å†³ï¼Ÿ

**åœºæ™¯ 1ï¼šå¤šä¸ª P åŒæ—¶å·åŒä¸€ä¸ªç›®æ ‡**

- P2 å’Œ P3 éƒ½è®¡ç®—å‡ºè¦å· `G1~G5` (`head=0` åˆ° `head=5`)
- P2 å…ˆæ‰§è¡Œ CAS æˆåŠŸï¼Œ`head` å˜ä¸º 5
- P3 æ‰§è¡Œ CAS å¤±è´¥ï¼ˆå› æœŸæœ› `head=0` ä½†å®é™…æ˜¯ 5ï¼‰ï¼ŒP3 **æ”¾å¼ƒæˆ–é‡è¯•**
- **ç»“æœ**ï¼šG åªèƒ½è¢«ä¸€ä¸ªäººå·èµ°ï¼Œä¸ä¼šé‡å¤æ‰§è¡Œ

**åœºæ™¯ 2ï¼šå·çªƒè€…å’Œæœ¬åœ° P æ’è½¦**

- P2 å‡†å¤‡å·ä¸€åŠ
- P1 è‡ªå·±é£å¿«åœ°å¤„ç†å®Œäº†è¿™äº› G
- P2 æ‰§è¡Œ CAS å¤±è´¥ï¼ˆå›  `head` å·²ç»è¢« P1 æ”¹äº†ï¼‰
- **ç»“æœ**ï¼šP2 å·çªƒå¤±è´¥ï¼Œé‡æ–°è®¡ç®—

### ä¸ºä»€ä¹ˆä»å°¾éƒ¨å·ï¼Ÿ

```
æœ¬åœ° P ä»å¤´éƒ¨å–ï¼ˆLIFOï¼‰â†’ åˆšåˆ›å»ºçš„ G ä¼˜å…ˆæ‰§è¡Œï¼Œç¼“å­˜çƒ­
å¤–éƒ¨ P ä»å°¾éƒ¨å·ï¼ˆFIFOï¼‰â†’ è€çš„ G è¢«å·èµ°ï¼Œå‡å°‘ç¼“å­˜å†²çª
```

**é¢è¯•ç®€ç­”**ï¼š
> "Work Stealing åº•å±‚ç”¨ç¯å½¢æ•°ç»„å­˜å‚¨æœ¬åœ°é˜Ÿåˆ—ï¼Œå·å–æ—¶é€šè¿‡ CAS åŸå­æ“ä½œæ›´æ–° head æŒ‡é’ˆï¼Œå®ç°æ— é”å¹¶å‘ã€‚æœ¬åœ° P ä»å¤´å–ï¼Œå¤–éƒ¨ P ä»å°¾å·ï¼Œå‡å°‘å†²çªã€‚æ¯æ¬¡å·ä¸€åŠï¼Œéšæœºé€‰ç›®æ ‡ï¼Œå®ç°è´Ÿè½½å‡è¡¡ã€‚"

---

## 5. åç¨‹æ ˆæ¼”è¿›

| ç‰ˆæœ¬ | æ ˆå®ç° | ç‰¹ç‚¹ |
|------|--------|------|
| Go 1.2 å‰ | **åˆ†æ®µæ ˆ** | æ ˆä¸å¤Ÿå°±æ–°åˆ†é…ä¸€æ®µï¼Œé“¾è¡¨è¿æ¥ |
| Go 1.3+ | **è¿ç»­æ ˆ** | æ ˆä¸å¤Ÿå°±æ•´ä½“å¤åˆ¶åˆ°æ›´å¤§çš„ç©ºé—´ |

### åˆ†æ®µæ ˆçš„é—®é¢˜

```
å‡½æ•° A è°ƒç”¨ Bï¼ŒB éœ€è¦æ›´å¤šæ ˆç©ºé—´
â†’ åˆ†é…æ–°æ®µ
â†’ B è¿”å›
â†’ é‡Šæ”¾æ–°æ®µ
â†’ A å†è°ƒç”¨ B
â†’ åˆåˆ†é…æ–°æ®µ...

çƒ­ç‚¹å‡½æ•°åå¤è§¦å‘ â†’ "æ ˆéœ‡è¡"ï¼ˆHot Splitï¼‰ï¼Œæ€§èƒ½å·®
```

### è¿ç»­æ ˆä¼˜åŠ¿

```
æ ˆä¸å¤Ÿ â†’ åˆ†é… 2 å€å¤§çš„æ–°æ ˆ â†’ æ•´ä½“å¤åˆ¶ â†’ æ›´æ–°æŒ‡é’ˆ
ä¸€æ¬¡å¤åˆ¶ï¼Œé•¿æœŸç¨³å®š
```

**å½“å‰å®ç°**ï¼šåˆå§‹ 2KBï¼Œæœ€å¤§ 1GBï¼ŒæŒ‰éœ€ 2 å€æ‰©å®¹ã€‚

---

## 6. I/O è°ƒåº¦æµç¨‹ï¼ˆä»¥ç½‘ç»œ I/O ä¸ºä¾‹ï¼‰

```
1. G è°ƒç”¨ net.Read()
2. Go runtime æ£€æŸ¥ï¼šæ•°æ®æ²¡å‡†å¤‡å¥½
3. æŠŠ G ä» P ä¸Šæ‘˜æ‰ï¼Œæ³¨å†Œåˆ° netpollerï¼ˆepoll/kqueueï¼‰
4. M ç»§ç»­æ‰§è¡Œ P ä¸Šçš„å…¶ä»– Gï¼ˆä¸é˜»å¡ï¼å…³é”®ï¼ï¼‰
5. å†…æ ¸æ•°æ®å°±ç»ª
6. netpoller æ„ŸçŸ¥ï¼ŒæŠŠ G æ”¾å›æŸä¸ª P çš„é˜Ÿåˆ—
7. G ç»§ç»­æ‰§è¡Œ
```

### å…³é”®ç‚¹

```
âŒ ä¼ ç»Ÿ Threadï¼šçº¿ç¨‹é˜»å¡åœ¨ I/Oï¼Œä»€ä¹ˆéƒ½ä¸èƒ½å¹²
âœ… Go Goroutineï¼šG å»ç­‰ I/Oï¼ŒM ç»§ç»­å¹²æ´»

è¿™å°±æ˜¯ä¸ºä»€ä¹ˆ Go èƒ½ç”¨å°‘é‡çº¿ç¨‹å¤„ç†å¤§é‡å¹¶å‘è¿æ¥ï¼
```

---

## 7. äº’æ–¥é”èƒ½å¦é‡å…¥ï¼Ÿ

**ä¸èƒ½ï¼** Go çš„ `sync.Mutex` æ˜¯**ä¸å¯é‡å…¥é”**ã€‚

```go
var mu sync.Mutex

func A() {
    mu.Lock()
    B()        // ğŸ’€ æ­»é”ï¼B é‡Œåˆ Lock åŒä¸€æŠŠé”
    mu.Unlock()
}

func B() {
    mu.Lock()   // æ°¸è¿œç­‰ä¸åˆ°ï¼ŒA è¿˜æ²¡ Unlock
    mu.Unlock()
}
```

### ä¸ºä»€ä¹ˆä¸æ”¯æŒå¯é‡å…¥ï¼Ÿ

```
Go è®¾è®¡å“²å­¦ï¼šç®€å• > åŠŸèƒ½å¤š
å¯é‡å…¥é”ä¼šæ©ç›–è®¾è®¡é—®é¢˜ï¼Œè®©é”™è¯¯æ›´éš¾å‘ç°
æ­£ç¡®åšæ³•ï¼šæ‹†åˆ†é”ä¿æŠ¤çš„é€»è¾‘ï¼Œæˆ–è€…ç”¨ä¸åŠ é”çš„å†…éƒ¨å‡½æ•°
```

---

## 8. å¹¶å‘å®‰å…¨é˜Ÿåˆ—è®¾è®¡

```go
type SafeQueue struct {
    items []interface{}
    mu    sync.Mutex
    cond  *sync.Cond
}

func NewSafeQueue() *SafeQueue {
    q := &SafeQueue{}
    q.cond = sync.NewCond(&q.mu)
    return q
}

func (q *SafeQueue) Push(item interface{}) {
    q.mu.Lock()
    q.items = append(q.items, item)
    q.cond.Signal()  // å”¤é†’ä¸€ä¸ªç­‰å¾…çš„æ¶ˆè´¹è€…
    q.mu.Unlock()
}

func (q *SafeQueue) Pop() interface{} {
    q.mu.Lock()
    for len(q.items) == 0 {
        q.cond.Wait()  // é˜Ÿåˆ—ç©ºå°±ç­‰å¾…
    }
    item := q.items[0]
    q.items = q.items[1:]
    q.mu.Unlock()
    return item
}
```

### è¿›é˜¶æ–¹æ¡ˆ

```
1. æ— é”é˜Ÿåˆ—ï¼šatomic + ç¯å½¢æ•°ç»„
2. åˆ†ç‰‡é˜Ÿåˆ—ï¼šå‡å°‘é”ç«äº‰
3. ç›´æ¥ç”¨ channelï¼šGo åŸç”Ÿçš„å¹¶å‘å®‰å…¨é˜Ÿåˆ—
```

---

## 9. é«˜å¹¶å‘ä¼˜åŒ–ç»éªŒï¼ˆç¤ºä¾‹å›ç­”ï¼‰

```
1. å¯¹è±¡å¤ç”¨ï¼šä½¿ç”¨ sync.Pool å‡å°‘ GC å‹åŠ›
   - æ•ˆæœï¼šQPS ä» 5000 æå‡åˆ° 8000

2. æ‰¹é‡å¤„ç†ï¼šåˆå¹¶å¤šæ¬¡å°è¯·æ±‚ä¸ºä¸€æ¬¡å¤§è¯·æ±‚
   - æ•ˆæœï¼šæ•°æ®åº“å‹åŠ›é™ä½ 70%

3. å¼‚æ­¥åŒ–ï¼šéå…³é”®è·¯å¾„ç”¨ channel + worker æ± 
   - æ•ˆæœï¼šæ¥å£å»¶è¿Ÿ P99 ä» 200ms é™åˆ° 50ms

4. æœ¬åœ°ç¼“å­˜ï¼šçƒ­ç‚¹æ•°æ®ç”¨ sync.Map æˆ–å•æœºç¼“å­˜
   - æ•ˆæœï¼šRedis è®¿é—®é‡é™ä½ 80%

5. è¿æ¥æ± ï¼šå¤ç”¨æ•°æ®åº“/HTTP è¿æ¥
   - æ•ˆæœï¼šè¿æ¥å»ºç«‹è€—æ—¶ä» 10ms é™ä¸º 0
```

---

## 10. å·²å…³é—­ Channel çš„è¯»å†™

| æ“ä½œ | å·²å…³é—­çš„ Channel | ç»“æœ |
|------|------------------|------|
| **å†™** | `ch <- v` | **panic: send on closed channel** |
| **è¯»** | `v := <-ch` | è¿”å›é›¶å€¼ï¼Œok ä¸º false |
| **å…³é—­** | `close(ch)` | **panic: close of closed channel** |

```go
ch := make(chan int, 1)
ch <- 1
close(ch)

v1 := <-ch         // v1 = 1, ok = true
v2, ok := <-ch     // v2 = 0, ok = falseï¼ˆå·²å…³é—­ä¸”ç©ºï¼‰
ch <- 2            // panic!
```

---

## 11. å¦‚ä½•æ£€æµ‹ Channel æ˜¯å¦å·²å…³é—­ï¼Ÿ

```go
// æ–¹æ³•1ï¼šè¯»å–æ—¶æ£€æŸ¥ç¬¬äºŒä¸ªè¿”å›å€¼
v, ok := <-ch
if !ok {
    fmt.Println("channel å·²å…³é—­")
}

// æ–¹æ³•2ï¼šfor-range è‡ªåŠ¨å¤„ç†
for v := range ch {
    fmt.Println(v)  // channel å…³é—­åè‡ªåŠ¨é€€å‡ºå¾ªç¯
}

// âš ï¸ æ²¡æœ‰ç›´æ¥æ£€æµ‹ closed çš„å‡½æ•°ï¼
// å› ä¸ºæ£€æµ‹åçŠ¶æ€å¯èƒ½ç«‹å³å˜åŒ–ï¼Œä¼šäº§ç”Ÿç«æ€
```

---

## 12. Select åº•å±‚åŸç†

### æ ¸å¿ƒé€»è¾‘

```
1. ç¼–è¯‘å™¨æŠŠæ‰€æœ‰ case è½¬æˆ scase æ•°ç»„
2. è¿è¡Œæ—¶æ‰“ä¹± case é¡ºåºï¼ˆéšæœºåŒ–ï¼ï¼‰
3. æŒ‰ä¹±åºä¾æ¬¡æ£€æŸ¥æ¯ä¸ª case æ˜¯å¦å°±ç»ª
4. å¦‚æœæœ‰å¤šä¸ªå°±ç»ªï¼Œéšæœºé€‰ä¸€ä¸ªæ‰§è¡Œ
5. å¦‚æœéƒ½æ²¡å°±ç»ªï¼š
   - æœ‰ default â†’ æ‰§è¡Œ default
   - æ—  default â†’ é˜»å¡ï¼ŒæŠŠ G æŒ‚åˆ°æ‰€æœ‰ channel çš„ç­‰å¾…é˜Ÿåˆ—
```

### éšæœºåŒ–è§£å†³é¥¥é¥¿é—®é¢˜

```go
// å¦‚æœå›ºå®šé¡ºåºï¼Œcase1 æ€»æ˜¯ä¼˜å…ˆ
select {
case <-ch1:  // æ€»æ˜¯å…ˆæ£€æŸ¥è¿™ä¸ª
case <-ch2:  // å¦‚æœ ch1 ä¸€ç›´æœ‰æ•°æ®ï¼Œch2 å¯èƒ½æ°¸è¿œå¾—ä¸åˆ°æ‰§è¡Œ
}

// éšæœºåŒ–åï¼Œæ¯æ¬¡æ£€æŸ¥é¡ºåºä¸åŒï¼Œæ‰€æœ‰ case æœºä¼šå‡ç­‰
```

---

## 13. å¤šä¸ª Case åŒæ—¶å°±ç»ªæ—¶çš„æ‰§è¡Œé€»è¾‘

```
éšæœºé€‰æ‹©ä¸€ä¸ªæ‰§è¡Œï¼

ä¸æ˜¯æŒ‰ä»£ç é¡ºåºï¼Œä¹Ÿä¸æ˜¯æŒ‰å°±ç»ªæ—¶é—´
æ˜¯çœŸæ­£çš„ä¼ªéšæœºé€‰æ‹©ï¼Œä¿è¯å…¬å¹³æ€§
```

### å›ºå®š Case é¡ºåºçš„æ½œåœ¨é—®é¢˜

```go
// âŒ é”™è¯¯å‡è®¾ï¼šä»¥ä¸º ch1 ä¼˜å…ˆçº§æ›´é«˜
select {
case <-ch1:
    // å¤„ç†é«˜ä¼˜å…ˆçº§æ¶ˆæ¯
case <-ch2:
    // å¤„ç†ä½ä¼˜å…ˆçº§æ¶ˆæ¯
}

// å®é™…ï¼šéšæœºé€‰æ‹©ï¼Œä¸ä¿è¯é¡ºåº
// å¦‚æœéœ€è¦ä¼˜å…ˆçº§ï¼Œè¦è‡ªå·±å®ç°é€»è¾‘
```

---

## 14. å‚æ•°ä¼ é€’æ–¹å¼

### æ ¸å¿ƒç»“è®ºï¼šGo åªæœ‰å€¼ä¼ é€’

ä½†è¦ç†è§£"å€¼"æ˜¯ä»€ä¹ˆï¼š

| ç±»å‹ | ä¼ é€’çš„"å€¼" | å‡½æ•°å†…ä¿®æ”¹æ•ˆæœ |
|------|-----------|---------------|
| int, bool, struct | æ•´ä¸ªæ•°æ®çš„æ‹·è´ | ä¸å½±å“å¤–éƒ¨ |
| æŒ‡é’ˆ *T | æŒ‡é’ˆåœ°å€çš„æ‹·è´ | é€šè¿‡æŒ‡é’ˆä¿®æ”¹ä¼šå½±å“å¤–éƒ¨ |
| slice | SliceHeader æ‹·è´ï¼ˆptr, len, capï¼‰ | ä¿®æ”¹å…ƒç´ å½±å“å¤–éƒ¨ï¼Œappend å¯èƒ½ä¸å½±å“ |
| map | *hmap æŒ‡é’ˆæ‹·è´ | ä¿®æ”¹ key-value å½±å“å¤–éƒ¨ |
| channel | *hchan æŒ‡é’ˆæ‹·è´ | åŒä¸€ä¸ª channel |

### Slice çš„ç‰¹æ®Šæƒ…å†µ

```go
func modify(s []int) {
    s[0] = 100   // âœ… å½±å“å¤–éƒ¨ï¼Œå› ä¸ºåº•å±‚æ•°ç»„æ˜¯åŒä¸€ä¸ª
    s = append(s, 999)  // âŒ å¯èƒ½ä¸å½±å“å¤–éƒ¨ï¼
    // append å¯èƒ½è§¦å‘æ‰©å®¹ï¼Œs æŒ‡å‘æ–°æ•°ç»„ï¼Œå¤–éƒ¨è¿˜æ˜¯è€æ•°ç»„
}
```

---

## 15. Slice å’Œ Map åº•å±‚ç»“æ„

### Slice åº•å±‚

```go
type slice struct {
    array unsafe.Pointer  // åº•å±‚æ•°ç»„æŒ‡é’ˆ
    len   int             // å½“å‰é•¿åº¦
    cap   int             // å®¹é‡
}

// ä¼ é€’ slice æ—¶ï¼Œå¤åˆ¶çš„æ˜¯è¿™ä¸ª 24 å­—èŠ‚çš„ç»“æ„ä½“
// ä½† array æŒ‡é’ˆæŒ‡å‘åŒä¸€å—å†…å­˜ï¼
```

### Map åº•å±‚

```go
// make(map[K]V) è¿”å›çš„å°±æ˜¯ *hmap æŒ‡é’ˆ
type hmap struct {
    count     int           // å…ƒç´ æ•°é‡
    buckets   unsafe.Pointer // æ¡¶æ•°ç»„
    // ...
}

// æ‰€ä»¥ map ä¼ å…¥å‡½æ•°ï¼Œä¿®æ”¹ä¼šå½±å“å¤–éƒ¨
// å› ä¸ºä¼ çš„æœ¬æ¥å°±æ˜¯æŒ‡é’ˆï¼
```

**é¢è¯•ç®€ç­”**ï¼š
> "Slice åº•å±‚æ˜¯ SliceHeaderï¼ˆæŒ‡é’ˆ+len+capï¼‰ï¼Œä¼ é€’æ—¶å¤åˆ¶ header ä½†å…±äº«åº•å±‚æ•°ç»„ã€‚Map æœ¬è´¨æ˜¯ *hmap æŒ‡é’ˆï¼Œæ‰€ä»¥ä¼ å…¥å‡½æ•°ä¿®æ”¹ä¼šå½±å“å¤–éƒ¨ã€‚"
